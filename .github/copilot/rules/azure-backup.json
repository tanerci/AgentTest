{
  "name": "Azure Backup and Recovery Rules",
  "version": "1.0",
  "description": "Azure backup policies, retention, geo-redundancy, and disaster recovery for Azure services",
  "rules": [
    {
      "id": "AZ-BACKUP-001",
      "category": "Backup Policies",
      "severity": "error",
      "title": "All production Azure resources must have backup policies",
      "description": "Azure SQL, Storage Accounts, Cosmos DB, and File Shares must have automated backup configured",
      "rationale": "Prevents data loss from accidental deletion, corruption, or security incidents.",
      "coverage": {
        "AzureSQLDatabase": "Required",
        "StorageAccount": "Required (Blob versioning + soft delete)",
        "CosmosDB": "Required (continuous backup or periodic)",
        "AzureFiles": "Required (Azure Backup vault)",
        "AzureVMs": "Required for stateful VMs"
      },
      "examples": {
        "bicep": [
          "resource sqlDatabase 'Microsoft.Sql/servers/databases@2022-05-01-preview' = {\n  properties: {\n    requestedBackupStorageRedundancy: 'Geo'\n  }\n}",
          "resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {\n  properties: {\n    isVersioningEnabled: true\n    deleteRetentionPolicy: {\n      enabled: true\n      days: 30\n    }\n  }\n}"
        ]
      }
    },
    {
      "id": "AZ-BACKUP-002",
      "category": "Retention Policy",
      "severity": "error",
      "title": "Backup retention must meet compliance requirements",
      "description": "Configure appropriate retention periods based on data criticality and compliance",
      "rationale": "Enables recovery from historical points and meets regulatory requirements.",
      "retentionRequirements": {
        "daily": "7-30 days minimum",
        "weekly": "4-12 weeks minimum",
        "monthly": "12 months minimum",
        "yearly": "7 years for compliance data"
      },
      "examples": {
        "azureSql": {
          "shortTermRetention": "7-35 days (point-in-time restore)",
          "longTermRetention": "Up to 10 years (weekly/monthly/yearly)"
        },
        "cosmosDb": {
          "continuousBackup": "30 days retention",
          "periodicBackup": "Configure retention policy"
        }
      }
    },
    {
      "id": "AZ-BACKUP-003",
      "category": "Geo-Redundancy",
      "severity": "error",
      "title": "Production data must use geo-redundant storage",
      "description": "Enable RA-GRS (Read-Access Geo-Redundant Storage) or GZRS for critical data",
      "rationale": "Protects against regional outages and enables disaster recovery to secondary region.",
      "storageRedundancy": {
        "critical": "RA-GRS or RA-GZRS (read access to secondary)",
        "important": "GRS or GZRS",
        "nonCritical": "ZRS (zone-redundant)",
        "development": "LRS (locally redundant)"
      },
      "examples": {
        "bicep": [
          "resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {\n  sku: {\n    name: 'Standard_RAGRS'\n  }\n  properties: {\n    allowBlobPublicAccess: false\n    minimumTlsVersion: 'TLS1_2'\n  }\n}"
        ]
      },
      "services": {
        "AzureSQLDatabase": "Geo-redundant backup enabled by default",
        "StorageAccount": "Set sku.name to Standard_RAGRS",
        "CosmosDB": "Multi-region writes or geo-replication"
      }
    },
    {
      "id": "AZ-BACKUP-004",
      "category": "Restore Runbooks",
      "severity": "error",
      "title": "Automated restore runbooks must exist and be tested",
      "description": "Maintain PowerShell/CLI scripts for restoring each Azure resource type",
      "rationale": "Reduces recovery time and eliminates manual errors during incidents.",
      "examples": {
        "azureSql": [
          "# Point-in-time restore\n$RestoreTime = (Get-Date).AddHours(-2)\nRestore-AzSqlDatabase -FromPointInTimeBackup `\n  -PointInTime $RestoreTime `\n  -ResourceGroupName 'myRG' `\n  -ServerName 'myserver' `\n  -TargetDatabaseName 'mydb-restored' `\n  -ResourceId (Get-AzSqlDatabase -ResourceGroupName 'myRG' -ServerName 'myserver' -DatabaseName 'mydb').ResourceId"
        ],
        "blob": [
          "# Restore from soft delete\n$StorageAccount = Get-AzStorageAccount -ResourceGroupName 'myRG' -Name 'mystorageaccount'\n$Ctx = $StorageAccount.Context\nGet-AzStorageBlob -Container 'mycontainer' -Context $Ctx -IncludeDeleted | Where-Object { $_.IsDeleted } | Restore-AzStorageBlob"
        ]
      },
      "runbookRequirements": [
        "Parameterized for different environments",
        "Idempotent execution",
        "Progress logging",
        "Validation checks",
        "Rollback capability",
        "Documentation inline"
      ]
    },
    {
      "id": "AZ-BACKUP-005",
      "category": "Recovery Point Testing",
      "severity": "warning",
      "title": "Verify backup integrity with test restores",
      "description": "Perform quarterly test restores to validate backup integrity and recovery procedures",
      "rationale": "Untested backups may be corrupted or incomplete. Regular testing ensures confidence.",
      "testingSchedule": {
        "frequency": "Quarterly minimum",
        "scope": "All critical databases and storage",
        "validation": "Data integrity checks, schema validation, connectivity tests"
      },
      "testScenarios": [
        "Point-in-time restore to specific timestamp",
        "Geo-restore to secondary region",
        "Restore to different subscription (DR scenario)",
        "Partial restore (specific tables/containers)",
        "Restore with network isolation"
      ]
    },
    {
      "id": "AZ-BACKUP-006",
      "category": "RPO/RTO Targets",
      "severity": "error",
      "title": "Define and monitor Recovery Point Objective (RPO) and Recovery Time Objective (RTO)",
      "description": "Document RPO/RTO targets for each service and monitor compliance",
      "rationale": "Ensures backup configuration meets business continuity requirements.",
      "targets": {
        "tier1Critical": {
          "RPO": "< 1 hour (continuous backup or frequent snapshots)",
          "RTO": "< 2 hours"
        },
        "tier2Important": {
          "RPO": "< 4 hours",
          "RTO": "< 8 hours"
        },
        "tier3Standard": {
          "RPO": "< 24 hours",
          "RTO": "< 24 hours"
        }
      },
      "monitoring": [
        "Track time since last successful backup",
        "Alert on backup failures",
        "Measure restore duration in drills",
        "Validate RPO/RTO in quarterly tests"
      ]
    },
    {
      "id": "AZ-BACKUP-007",
      "category": "Encryption",
      "severity": "error",
      "title": "Backups must be encrypted at rest and in transit",
      "description": "Use Azure Key Vault for encryption keys and enable TLS for data transfer",
      "rationale": "Protects sensitive data in backups from unauthorized access.",
      "requirements": {
        "encryptionAtRest": "Microsoft-managed or customer-managed keys",
        "encryptionInTransit": "TLS 1.2 minimum",
        "keyManagement": "Azure Key Vault with RBAC",
        "keyRotation": "Annual minimum"
      },
      "examples": {
        "bicep": [
          "resource sqlDatabase 'Microsoft.Sql/servers/databases@2022-05-01-preview' = {\n  properties: {\n    transparentDataEncryption: {\n      state: 'Enabled'\n    }\n  }\n}",
          "resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {\n  properties: {\n    encryption: {\n      services: {\n        blob: { enabled: true }\n        file: { enabled: true }\n      }\n      keySource: 'Microsoft.Keyvault'\n      keyvaultproperties: {\n        keyvaulturi: keyVault.properties.vaultUri\n        keyname: 'storage-encryption-key'\n      }\n    }\n  }\n}"
        ]
      }
    },
    {
      "id": "AZ-BACKUP-008",
      "category": "Cross-Region Replication",
      "severity": "warning",
      "title": "Enable cross-region replication for disaster recovery",
      "description": "Configure read replicas or geo-replication to secondary Azure regions",
      "rationale": "Enables failover to secondary region during primary region outage.",
      "services": {
        "AzureSQLDatabase": "Geo-replication or Failover groups",
        "CosmosDB": "Multi-region writes or read replicas",
        "StorageAccount": "RA-GRS provides read access to secondary",
        "AppService": "Azure Front Door with multi-region backends"
      },
      "regionPairing": {
        "EastUS": "WestUS",
        "NorthEurope": "WestEurope",
        "SoutheastAsia": "EastAsia"
      }
    },
    {
      "id": "AZ-BACKUP-009",
      "category": "Immutable Backups",
      "severity": "warning",
      "title": "Use immutable storage for critical backups",
      "description": "Configure immutable blob storage to prevent deletion or modification of backups",
      "rationale": "Protects against ransomware and malicious deletion (insider threats).",
      "examples": {
        "bicep": [
          "resource container 'Microsoft.Storage/storageAccounts/blobServices/containers@2023-01-01' = {\n  properties: {\n    immutableStorageWithVersioning: {\n      enabled: true\n    }\n  }\n}"
        ]
      },
      "immutabilityPolicies": {
        "timeBased": "Lock backups for specific period (e.g., 90 days)",
        "legalHold": "Prevent deletion until legal hold removed"
      }
    },
    {
      "id": "AZ-BACKUP-010",
      "category": "Monitoring and Alerts",
      "severity": "error",
      "title": "Configure alerts for backup failures and policy violations",
      "description": "Set up Azure Monitor alerts for backup job failures, missing backups, and retention violations",
      "rationale": "Enables proactive response to backup issues before data loss occurs.",
      "alerts": [
        "Backup job failure",
        "Backup not completed within SLA window",
        "Backup size anomaly (too small may indicate failure)",
        "Geo-replication lag exceeds threshold",
        "Restore drill failure"
      ],
      "examples": {
        "azureMonitor": [
          "resource backupAlert 'Microsoft.Insights/metricAlerts@2018-03-01' = {\n  properties: {\n    criteria: {\n      allOf: [\n        {\n          name: 'BackupHealth'\n          metricName: 'BackupHealthEvent'\n          operator: 'LessThan'\n          threshold: 1\n          timeAggregation: 'Average'\n        }\n      ]\n    }\n    actions: [\n      {\n        actionGroupId: actionGroup.id\n      }\n    ]\n  }\n}"
        ]
      }
    }
  ],
  "bestPractices": [
    "Implement 3-2-1 backup strategy (3 copies, 2 media types, 1 offsite)",
    "Use Azure Backup vault for centralized management",
    "Tag resources with backup tier (critical, important, standard)",
    "Document restore procedures in runbooks",
    "Test disaster recovery quarterly",
    "Use Azure Policy to enforce backup compliance",
    "Implement soft delete for all storage accounts",
    "Enable versioning for blob storage"
  ],
  "azureServices": {
    "AzureBackup": "Unified backup service for VMs, databases, file shares",
    "AzureSiteRecovery": "Disaster recovery orchestration",
    "AzureMonitor": "Alerts and monitoring for backup health",
    "AzurePolicy": "Enforce backup configuration compliance"
  },
  "complianceFrameworks": [
    "GDPR - Right to data recovery",
    "HIPAA - 6-year retention for healthcare data",
    "SOC 2 - Business continuity and availability",
    "ISO 27001 - Information backup procedures"
  ]
}
